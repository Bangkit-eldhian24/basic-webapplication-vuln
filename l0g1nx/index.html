from flask import Flask, request, render_template_string, redirect, url_for, session
import sqlite3
import subprocess
import requests
import os
import html

app = Flask(__name__)
app.secret_key = 'vulnerable_secret_key'

# HTML template sebagai string
HTML_TEMPLATE = '''
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VulnWeb - Aplikasi Demonstrasi Keamanan</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .nav { background: #333; padding: 10px; margin-bottom: 20px; }
        .nav a { color: white; text-decoration: none; padding: 10px 15px; }
        .nav a:hover { background: #555; }
        .vuln-section { border: 1px solid #ddd; padding: 20px; margin: 10px 0; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 10px 0; }
        form { margin: 10px 0; }
        input, button { padding: 8px; margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîì VulnWeb - Demonstrasi Kerentanan</h1>
        <div class="warning">
            <strong>PERINGATAN:</strong> Aplikasi ini mengandung kerentanan keamanan yang disengaja. 
            Hanya gunakan di lingkungan testing yang terkontrol!
        </div>

        <div class="nav">
            <a href="#xss">XSS</a>
            <a href="#sqli">SQL Injection</a>
            <a href="#rce">RCE</a>
            <a href="#idor">IDOR</a>
            <a href="#csrf">CSRF</a>
            <a href="#ssrf">SSRF</a>
        </div>

        <!-- XSS Section -->
        <div id="xss" class="vuln-section">
            <h2>üîç Cross-Site Scripting (XSS)</h2>
            <form method="GET" action="/search">
                <input type="text" name="q" placeholder="Cari sesuatu..." style="width: 300px;">
                <button type="submit">Cari</button>
            </form>
            <div id="search-results">
                <!-- Results will appear here -->
            </div>
        </div>

        <!-- SQL Injection Section -->
        <div id="sqli" class="vuln-section">
            <h2>üóÉÔ∏è SQL Injection</h2>
            <form method="POST" action="/login">
                <input type="text" name="username" placeholder="Username" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit">Login</button>
            </form>
            <p><strong>Test Credentials:</strong></p>
            <p>Username: <code>admin</code> | Password: <code>password123</code></p>
            <p><strong>SQL Injection:</strong> Username: <code>' OR '1'='1' --</code> | Password: <code>anything</code></p>
        </div>

        <!-- RCE Section -->
        <div id="rce" class="vuln-section">
            <h2>‚ö° Remote Code Execution (RCE)</h2>
            <form method="POST" action="/ping">
                <input type="text" name="host" placeholder="Masukkan host/ip" value="127.0.0.1">
                <button type="submit">Ping</button>
            </form>
            <p><strong>Contoh RCE:</strong> <code>127.0.0.1; whoami</code></p>
        </div>

        <!-- IDOR Section -->
        <div id="idor" class="vuln-section">
            <h2>üëÅÔ∏è Insecure Direct Object Reference (IDOR)</h2>
            <p><a href="/profile/1">Lihat Profil Saya (ID: 1)</a></p>
            <p><a href="/profile/2">Lihat Profil User Lain (ID: 2)</a></p>
            <p><a href="/profile/3">Lihat Profil Tidak Ada (ID: 3)</a></p>
        </div>

        <!-- CSRF Section -->
        <div id="csrf" class="vuln-section">
            <h2>üîÑ Cross-Site Request Forgery (CSRF)</h2>
            <form method="POST" action="/transfer">
                <input type="number" name="amount" placeholder="Jumlah transfer" value="1000000">
                <input type="text" name="to_account" placeholder="Rekening tujuan" value="ATTACKER123">
                <button type="submit">Transfer</button>
            </form>
        </div>

        <!-- SSRF Section -->
        <div id="ssrf" class="vuln-section">
            <h2>üåê Server-Side Request Forgery (SSRF)</h2>
            <form method="POST" action="/fetch">
                <input type="text" name="url" placeholder="URL untuk di-fetch" style="width: 400px;" 
                       value="http://localhost:5000">
                <button type="submit">Fetch URL</button>
            </form>
            <p><strong>Contoh SSRF:</strong> <code>file:///etc/passwd</code> (Linux) atau <code>file:///C:/Windows/System32/drivers/etc/hosts</code> (Windows)</p>
        </div>
    </div>

    <script>
        // Client-side XSS demonstration
        const urlParams = new URLSearchParams(window.location.search);
        const searchQuery = urlParams.get('q');
        if (searchQuery) {
            document.getElementById('search-results').innerHTML = 
                `<p>Hasil pencarian untuk: <strong>${searchQuery}</strong></p>`;
        }
    </script>
</body>
</html>
'''

# Database setup
def init_db():
    conn = sqlite3.connect('database.db', check_same_thread=False)
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS users
                 (id INTEGER PRIMARY KEY, username TEXT, password TEXT, email TEXT)''')
    
    # Clear existing data and insert fresh
    c.execute("DELETE FROM users")
    c.execute("INSERT INTO users VALUES (1, 'admin', 'password123', 'admin@example.com')")
    c.execute("INSERT INTO users VALUES (2, 'user1', 'pass123', 'user1@example.com')")
    conn.commit()
    conn.close()

# üîì XSS Vulnerability
@app.route('/search')
def search():
    query = request.args.get('q', '')
    # Vulnerable: No output encoding
    return f'''
    <h2>Hasil Pencarian</h2>
    <p>Query: {query}</p>
    <p><strong>Vulnerable XSS - try:</strong> <code>&lt;script&gt;alert('XSS')&lt;/script&gt;</code></p>
    <a href="/">Kembali</a>
    '''

# üóÉÔ∏è SQL Injection Vulnerability
@app.route('/login', methods=['POST'])
def login():
    username = request.form.get('username', '')
    password = request.form.get('password', '')
    
    # Vulnerable: Direct string concatenation
    conn = sqlite3.connect('database.db', check_same_thread=False)
    c = conn.cursor()
    query = f"SELECT * FROM users WHERE username = '{username}' AND password = '{password}'"
    
    try:
        c.execute(query)
        user = c.fetchone()
        if user:
            return f'''
            <h2>Login berhasil! ‚úÖ</h2>
            <p>Welcome {user[1]} (ID: {user[0]})</p>
            <p>Email: {user[3]}</p>
            <p><strong>Query yang dijalankan:</strong> <code>{html.escape(query)}</code></p>
            <a href="/">Kembali</a>
            '''
        else:
            return f'''
            <h2>Login gagal! ‚ùå</h2>
            <p><strong>Query yang dijalankan:</strong> <code>{html.escape(query)}</code></p>
            <a href="/">Coba lagi</a>
            '''
    except Exception as e:
        return f'''
        <h2>Error SQL</h2>
        <p>Error: {str(e)}</p>
        <p><strong>Query:</strong> <code>{html.escape(query)}</code></p>
        <a href="/">Kembali</a>
        '''
    finally:
        conn.close()

# ‚ö° RCE Vulnerability
@app.route('/ping', methods=['POST'])
def ping():
    host = request.form.get('host', '127.0.0.1')
    
    # Vulnerable: Direct command execution
    try:
        # Deteksi OS
        if os.name == 'nt':  # Windows
            cmd = f'ping -n 2 {host}'
        else:  # Linux/Mac
            cmd = f'ping -c 2 {host}'
            
        result = subprocess.check_output(cmd, shell=True, stderr=subprocess.STDOUT)
        return f'''
        <h2>Hasil Ping</h2>
        <p><strong>Command:</strong> <code>{html.escape(cmd)}</code></p>
        <pre>{html.escape(result.decode())}</pre>
        <a href="/">Kembali</a>
        '''
    except subprocess.CalledProcessError as e:
        return f'''
        <h2>Error Ping</h2>
        <p><strong>Command:</strong> <code>{html.escape(cmd)}</code></p>
        <pre>Error: {html.escape(e.output.decode())}</pre>
        <a href="/">Kembali</a>
        '''
    except Exception as e:
        return f'''
        <h2>Error</h2>
        <p>Error: {str(e)}</p>
        <a href="/">Kembali</a>
        '''

# üëÅÔ∏è IDOR Vulnerability
@app.route('/profile/<int:user_id>')
def profile(user_id):
    conn = sqlite3.connect('database.db', check_same_thread=False)
    c = conn.cursor()
    c.execute("SELECT * FROM users WHERE id = ?", (user_id,))
    user = c.fetchone()
    conn.close()
    
    if user:
        # Vulnerable: No authorization check
        return f'''
        <h2>Profil User</h2>
        <p><strong>ID:</strong> {user[0]}</p>
        <p><strong>Username:</strong> {user[1]}</p>
        <p><strong>Password:</strong> {user[2]}</p>
        <p><strong>Email:</strong> {user[3]}</p>
        <div class="warning">
            <strong>VULNERABLE IDOR:</strong> Anda bisa akses profil user lain tanpa authorization!
        </div>
        <a href="/">Kembali</a>
        '''
    else:
        return '''
        <h2>User tidak ditemukan</h2>
        <a href="/">Kembali</a>
        '''

# üîÑ CSRF Vulnerability
@app.route('/transfer', methods=['POST'])
def transfer():
    amount = request.form.get('amount')
    to_account = request.form.get('to_account')
    
    # Vulnerable: No CSRF protection
    return f'''
    <h2>Transfer Berhasil! üí∏</h2>
    <p><strong>Jumlah:</strong> Rp {amount}</p>
    <p><strong>Ke rekening:</strong> {to_account}</p>
    <div class="warning">
        <strong>VULNERABLE CSRF:</strong> Request ini tidak ada CSRF protection!
    </div>
    <a href="/">Kembali</a>
    '''

# üåê SSRF Vulnerability
@app.route('/fetch', methods=['POST'])
def fetch_url():
    url = request.form.get('url', 'http://localhost:5000')
    
    # Vulnerable: No URL validation
    try:
        response = requests.get(url, timeout=5)
        return f'''
        <h2>Hasil Fetch</h2>
        <p><strong>URL:</strong> {html.escape(url)}</p>
        <p><strong>Status Code:</strong> {response.status_code}</p>
        <pre>{html.escape(response.text[:2000])}</pre>
        <a href="/">Kembali</a>
        '''
    except Exception as e:
        return f'''
        <h2>Error Fetch</h2>
        <p><strong>URL:</strong> {html.escape(url)}</p>
        <p>Error: {str(e)}</p>
        <a href="/">Kembali</a>
        '''

@app.route('/')
def index():
    return render_template_string(HTML_TEMPLATE)

if __name__ == '__main__':
    init_db()
    print("=" * 60)
    print("üîì VULNWEB - Demonstrasi Kerentanan Keamanan")
    print("=" * 60)
    print("üìù Credentials untuk testing:")
    print("   Admin: username='admin' password='password123'")
    print("   User1: username='user1' password='pass123'")
    print("üíâ SQL Injection: username=\"' OR '1'='1' --\" password='anything'")
    print("‚ö†Ô∏è  JALANKAN DI LINGKUNGAN TERISOLASI!")
    print("üåê Aplikasi berjalan di http://localhost:5000")
    print("=" * 60)
    app.run(debug=True, host='0.0.0.0', port=5000)